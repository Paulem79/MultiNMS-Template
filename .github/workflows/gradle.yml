name: ğŸ”¨ Build
on: [pull_request, push]

jobs:
  define-matrix:
    runs-on: ubuntu-latest

    outputs:
      versions: ${{ steps.versions.outputs.versions }}

    steps:
      - name: Define versions
        id: versions
        run: |
          echo 'versions=["1.19.4", "1.20.1", "1.20.2", "1.20.4"]' >> "$GITHUB_OUTPUT"

  buildtools:
    name: ğŸ”¨ BuildTools
    runs-on: ubuntu-latest
    permissions: write-all
    needs: define-matrix
    strategy:
      matrix:
        versions: ${{ fromJSON(needs.define-matrix.outputs.versions) }}

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â¬‡ Download BuildTools
        run: |
          mkdir -p buildtools
          cd buildtools
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar

      - name: ğŸ› ï¸ Setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          java-package: jdk

      - name: ğŸ’ª Run BuildTools
        run: |
          cd buildtools
          java -jar BuildTools.jar --rev ${{ matrix.versions }} --remapped

      - name: Home in env
        run:
          echo "HOME=$HOME" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: maven-repo-${{ matrix.versions }}
          path: ${{ env.HOME }}/.m2

  build:
    name: ğŸ”¨ Build project
    runs-on: ubuntu-latest
    permissions: write-all
    needs:
      - define-matrix
      - buildtools
    strategy:
      matrix:
        versions: ${{ fromJSON(needs.define-matrix.outputs.versions) }}

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Home in env
        run:
          echo "HOME=$HOME" >> $GITHUB_ENV

      - uses: actions/download-artifact@v4
        with:
          name: maven-repo-${{ matrix.versions }}
          path: ${{ env.HOME }}/.m2

      - name: ğŸª„ Cache gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ./.gradle/loom-cache
          key: ${{ runner.os }}-gradle0-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle0-

      - name: âœ… Validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: ğŸ› ï¸ Setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          java-package: jdk

      - name: ğŸ†™ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ”¨ Build project
        run: ./gradlew build