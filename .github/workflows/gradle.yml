name: üî® Build
on: [pull_request, push]

jobs:
  define-matrix:
    runs-on: ubuntu-latest

    outputs:
      versions: ${{ steps.versions.outputs.versions }}

    steps:
      - name: Define versions
        id: versions
        run: |
          echo 'versions=[{ name:"1.19.4", java: 17 }, { name:"1.20.1", java: 17 }, { name:"1.20.2", java: 17 }, { name:"1.20.4", java: 17 }]' >> "$GITHUB_OUTPUT"

  buildtools:
    name: üî® BuildTools
    runs-on: ubuntu-latest
    permissions: write-all
    needs: define-matrix

    strategy:
      fail-fast: true
      matrix:
        versions: ${{ fromJSON(needs.define-matrix.outputs.versions) }}

    env:
      VERSION_NAME: ${{ matrix.versions.name }}
      JAVA_VERSION: ${{ matrix.versions.java }}

    steps:
      - name: ‚úÖ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Echo version
        run: echo "Building for ${{ env.VERSION_NAME }} with java ${{ env.JAVA_VERSION }}"

      - name: ‚¨á Download BuildTools
        run: |
          mkdir -p buildtools
          cd buildtools
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar

      - name: üõ†Ô∏è Setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          java-package: jdk

      - name: Home in env
        run:
          echo "HOME=$HOME" >> $GITHUB_ENV

      - name: Create maven repo
        run: |
          mkdir -p ${{ env.HOME }}/.m2

      - name: üí™ Run BuildTools
        run: |
          cd buildtools
          java -jar BuildTools.jar --rev ${{ env.VERSION_NAME }} --remapped

      - name: Create zip
        uses: ihiroky/archive-action@v1
        with:
          root_dir: ${{ env.HOME }}/.m2
          file_path: ${{ env.HOME }}/maven-repo-${{ env.VERSION_NAME }}.zip

      - uses: actions/upload-artifact@v4
        with:
          name: maven-repo-${{ env.VERSION_NAME }}
          path: ${{ env.HOME }}/maven-repo-${{ env.VERSION_NAME }}.zip
          include-hidden-files: 'true'
          if-no-files-found: 'error'

  build:
    name: üî® Build project
    runs-on: ubuntu-latest
    permissions: write-all
    needs:
      - define-matrix
      - buildtools

    steps:
      - name: ‚úÖ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Home in env
        run:
          echo "HOME=$HOME" >> $GITHUB_ENV

      - name: Download compiled jars
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.HOME }}

      - name: Extract zip 1.19.4
        uses: ihiroky/extract-action@v1
        with:
          file_path: ${{ env.HOME }}/maven-repo-1.19.4.zip
          extract_dir: ${{ env.HOME }}/.m2

      - name: Extract zip 1.20.1
        uses: ihiroky/extract-action@v1
        with:
          file_path: ${{ env.HOME }}/maven-repo-1.20.1.zip
          extract_dir: ${{ env.HOME }}/.m2

      - name: Extract zip 1.20.2
        uses: ihiroky/extract-action@v1
        with:
          file_path: ${{ env.HOME }}/maven-repo-1.20.2.zip
          extract_dir: ${{ env.HOME }}/.m2

      - name: Extract zip 1.20.4
        uses: ihiroky/extract-action@v1
        with:
          file_path: ${{ env.HOME }}/maven-repo-1.20.4.zip
          extract_dir: ${{ env.HOME }}/.m2

      - name: ü™Ñ Cache gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ./.gradle/loom-cache
          key: ${{ runner.os }}-gradle0-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle0-

      - name: ‚úÖ Validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: üõ†Ô∏è Setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          java-package: jdk

      - name: üÜô Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: üî® Build project
        run: ./gradlew build