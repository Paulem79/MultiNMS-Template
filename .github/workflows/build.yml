name: ğŸ”¨ Build
on: [pull_request, push]

jobs:
  define-matrix:
    name: ğŸ§© Define matrix
    runs-on: ubuntu-latest

    outputs:
      versions: ${{ steps.versions.outputs.versions }}

    steps:
      - name: ğŸ§© Define versions
        id: versions
        # TODO: Analyse subprojects gradle.properties for version and java version
        run: |
          echo 'versions=[{ name:"1.19.4", java: 17 }, { name:"1.20.1", java: 17 }, { name:"1.20.2", java: 17 }, { name:"1.20.4", java: 17 }]' >> "$GITHUB_OUTPUT"

  buildtools:
    name: ğŸ”¨ BuildTools
    runs-on: ubuntu-latest
    permissions: write-all
    needs: define-matrix

    strategy:
      fail-fast: true
      matrix:
        versions: ${{ fromJSON(needs.define-matrix.outputs.versions) }}

    env:
      VERSION_NAME: ${{ matrix.versions.name }}
      JAVA_VERSION: ${{ matrix.versions.java }}

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download BuildTools
        run: |
          mkdir -p buildtools
          cd buildtools
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar

      - name: ğŸ› ï¸ Setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          java-package: jdk

      - name: ğŸ  Home in env
        run:
          echo "HOME=$HOME" >> $GITHUB_ENV

      - name: ğŸ“‚ Create maven repo
        run: |
          mkdir -p ${{ env.HOME }}/.m2

      - name: ğŸ’ª Run BuildTools
        run: |
          cd buildtools
          java -jar BuildTools.jar --rev ${{ env.VERSION_NAME }} --remapped

      - name: ğŸ“¦ Upload maven repo
        uses: actions/upload-artifact@v4
        with:
          name: maven-repo-${{ env.VERSION_NAME }}
          path: ${{ env.HOME }}/.m2
          include-hidden-files: 'true'
          if-no-files-found: 'error'

  build:
    name: ğŸ”¨ Build project
    runs-on: ubuntu-latest
    permissions: write-all
    needs:
      - define-matrix
      - buildtools

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ  Home in env
        run:
          echo "HOME=$HOME" >> $GITHUB_ENV

      - name: ğŸ“¥ Download maven repos
        uses: actions/download-artifact@v4

      - name: ğŸ“‚ Move contents to .m2
        run: |
                for dir in ${{ env.HOME }}/maven-repo-*; do
                  if [ -d "$dir" ]; then
                    cp -rT "$dir" "${{ env.HOME }}/.m2"
                  fi
                done

      - name: ğŸª„ Cache gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ./.gradle/loom-cache
          key: ${{ runner.os }}-gradle0-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle0-

      - name: âœ… Validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: ğŸ› ï¸ Setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          java-package: jdk

      - name: ğŸ†™ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ”¨ Build project
        run: ./gradlew build

      - name: ğŸ—‘ï¸ Delete maven repos (âœ¨ DMCA âœ¨)
        uses: geekyeggo/delete-artifact@v5
        with:
          name: maven-repo-*